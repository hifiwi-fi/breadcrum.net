#!/usr/bin/env bash

set -e

# Get the current branch name
TARGET_BRANCH=$(git branch --show-current)
BRANCH_NAME="regenerate-lockfile-${GITHUB_RUN_NUMBER:-$(date +%s)}"
COMMIT_MESSAGE="chore: regenerate package-lock.json"
PR_TITLE="chore: regenerate package-lock.json"

echo "ğŸ¯ Target branch: $TARGET_BRANCH"

# Configure git
git config user.name "github-actions[bot]"
git config user.email "github-actions[bot]@users.noreply.github.com"

# Delete existing package-lock.json
echo "ğŸ—‘ï¸  Deleting existing package-lock.json..."
rm -f package-lock.json

# Run npm install to generate new lockfile
echo "ğŸ“¦ Running npm install..."
npm install

# Check if there are changes
if git diff --exit-code package-lock.json > /dev/null 2>&1; then
  echo "âœ… No changes detected in package-lock.json"
  exit 0
fi

echo "ğŸ“ Changes detected in package-lock.json"

# Create a new branch
echo "ğŸŒ¿ Creating branch: $BRANCH_NAME"
git checkout -b "$BRANCH_NAME"

# Stage and commit changes
echo "ğŸ’¾ Committing changes..."
git add package-lock.json
git commit -m "$COMMIT_MESSAGE"

# Push the branch
echo "â¬†ï¸  Pushing branch to origin..."
git push origin "$BRANCH_NAME"

# Create PR body
PR_BODY="This PR was automatically generated by the regenerate-lockfile workflow.

The package-lock.json file has been regenerated by deleting the existing lockfile and running \`npm install\`.

Please review the changes before merging.

Triggered by: @${GITHUB_ACTOR:-unknown}
Run number: ${GITHUB_RUN_NUMBER:-N/A}
Base branch: $TARGET_BRANCH"

# Create PR using GitHub CLI
echo "ğŸ”€ Creating pull request..."
gh pr create \
  --base "$TARGET_BRANCH" \
  --head "$BRANCH_NAME" \
  --title "$PR_TITLE" \
  --body "$PR_BODY"

echo "âœ… Pull request created successfully"
