#!/usr/bin/env bash

set -e

# Get the current branch name
TARGET_BRANCH=$(git branch --show-current)
BRANCH_NAME="regenerate-lockfile-${GITHUB_RUN_NUMBER:-$(date +%s)}"

echo "ğŸ¯ Target branch: $TARGET_BRANCH"

# Configure git
git config user.name "github-actions[bot]"
git config user.email "github-actions[bot]@users.noreply.github.com"

# Capture outdated packages before regenerating
echo "ğŸ“Š Checking for outdated packages..."
OUTDATED_BEFORE=$(pnpm outdated || true)

# Delete existing pnpm-lock.yaml
echo "ğŸ—‘ï¸  Deleting existing pnpm-lock.yaml..."
rm -f pnpm-lock.yaml

# Run pnpm install to generate new lockfile
echo "ğŸ“¦ Running pnpm install..."
pnpm install

# Capture outdated packages after regenerating
OUTDATED_AFTER=$(pnpm outdated || true)

# Check if there are changes
if git diff --exit-code pnpm-lock.yaml > /dev/null 2>&1; then
  echo "âœ… No changes detected in pnpm-lock.yaml"
  exit 0
fi

echo "ğŸ“ Changes detected in pnpm-lock.yaml"

# Create a new branch
echo "ğŸŒ¿ Creating branch: $BRANCH_NAME"
git checkout -b "$BRANCH_NAME"

# Stage changes
git add pnpm-lock.yaml

# Get the diff stats
DIFF_STAT=$(git diff --staged --stat pnpm-lock.yaml)

# Build commit message with formatted diff
COMMIT_MESSAGE="chore: regenerate pnpm-lock.yaml

\`\`\`diff
${DIFF_STAT}
\`\`\`"

if [ -n "$OUTDATED_BEFORE" ]; then
  COMMIT_MESSAGE="${COMMIT_MESSAGE}

Outdated packages before regeneration:
${OUTDATED_BEFORE}"
fi

# Commit changes
echo "ğŸ’¾ Committing changes..."
git commit -m "$COMMIT_MESSAGE"

# Push the branch
echo "â¬†ï¸  Pushing branch to origin..."
git push origin "$BRANCH_NAME"

# Build PR body with outdated package information
PR_BODY="## ğŸ”„ Regenerate pnpm-lock.yaml

This PR was automatically generated by the regenerate-lockfile workflow.

The \`pnpm-lock.yaml\` file has been regenerated by deleting the existing lockfile and running \`pnpm install\`.

### ğŸ“Š Changes

\`\`\`diff
${DIFF_STAT}
\`\`\`"

if [ -n "$OUTDATED_BEFORE" ]; then
  PR_BODY="${PR_BODY}

### ğŸ“¦ Outdated Packages (Before Regeneration)

\`\`\`
${OUTDATED_BEFORE}
\`\`\`"
fi

if [ -n "$OUTDATED_AFTER" ] && [ "$OUTDATED_AFTER" != "$OUTDATED_BEFORE" ]; then
  PR_BODY="${PR_BODY}

### ğŸ“¦ Outdated Packages (After Regeneration)

\`\`\`
${OUTDATED_AFTER}
\`\`\`"
fi

PR_BODY="${PR_BODY}

---

**Triggered by:** @${GITHUB_ACTOR:-unknown}
**Run number:** ${GITHUB_RUN_NUMBER:-N/A}
**Base branch:** ${TARGET_BRANCH}"

# Create PR using GitHub CLI
echo "ğŸ”€ Creating pull request..."
gh pr create \
  --base "$TARGET_BRANCH" \
  --head "$BRANCH_NAME" \
  --title "chore: regenerate pnpm-lock.yaml" \
  --body "$PR_BODY"

echo "âœ… Pull request created successfully"
